<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El ÑBS de Luis</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: #fff;
            font-family: Arial, sans-serif;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .controls {
            background-color: #2b2b2b;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .preview-box {
            position: relative;
        }

        .preview-title {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .preview {
            width: 100%;
            aspect-ratio: 16/9;
            background-color: #000;
            border-radius: 8px;
            object-fit: contain;
        }

        button {
            background-color: #444;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }

        button:hover {
            background-color: #555;
        }

        button:disabled {
            background-color: #333;
            cursor: not-allowed;
        }

        .record-button {
            background-color: #cc0000;
            font-weight: bold;
        }

        .record-button:hover {
            background-color: #ff0000;
        }

        .recording-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            color: #ff0000;
            font-weight: bold;
            margin: 10px 0;
        }

        .recording-indicator.active {
            display: flex;
        }

        .recording-indicator::before {
            content: "●";
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        .status {
            margin-top: 10px;
            padding: 10px;
            background-color: #333;
            border-radius: 4px;
        }

        video, canvas {
            width: 100%;
            border-radius: 8px;
        }

        .pip-button {
            background-color: #0066cc;
        }

        .pip-button:hover {
            background-color: #0052a3;
        }

        .source-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .screen-button { background-color: #2ecc71; }
        .camera-button { background-color: #e74c3c; }
        .mic-button { background-color: #f39c12; }
        .image-button { background-color: #9b59b6; }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal {
            background-color: #2b2b2b;
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
        }

        .modal-title {
            margin: 0 0 15px 0;
            color: white;
        }

        .modal-content {
            margin-bottom: 15px;
        }

        .image-selector {
            display: grid;
            gap: 10px;
            margin: 10px 0;
        }

        .image-option {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #333;
            border-radius: 4px;
            cursor: pointer;
        }

        .image-option:hover {
            background: #444;
        }

        .image-option input[type="checkbox"] {
            margin-right: 10px;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .floating-image {
            position: fixed;
            z-index: 9999;
            border: 2px solid #fff;
            border-radius: 8px;
            cursor: move;
            resize: both;
            overflow: hidden;
        }

        .floating-image canvas {
            width: 100%;
            height: 100%;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <h2>Grabador Multimedia</h2>
            <div class="source-buttons">
                <button id="screenButton" class="screen-button">Añadir Pantalla</button>
                <button id="cameraButton" class="camera-button">Añadir Cámara</button>
                <button id="micButton" class="mic-button">Añadir Micrófono</button>
                <button id="imageButton" class="image-button">Añadir Imágenes</button>
            </div>
            <button id="pipButton" class="pip-button" disabled>Activar Cámara Flotante</button>
            <button id="floatImageButton" class="pip-button" disabled>Activar Imagen Flotante</button>
            <button id="recordButton" class="record-button" disabled>Iniciar Grabación</button>
            <div class="recording-indicator">Grabando</div>
            <div class="status" id="status">Estado: Esperando configuración...</div>
        </div>
        
        <div class="preview-container">
            <div class="preview-box">
                <div class="preview-title">Vista previa de la pantalla</div>
                <video id="screenPreview" class="preview" autoplay muted playsinline></video>
            </div>
            <div class="preview-box">
                <div class="preview-title">Vista previa de la cámara</div>
                <video id="cameraPreview" class="preview" autoplay muted playsinline></video>
            </div>
        </div>
    </div>

    <!-- Modal para selección de imágenes -->
    <div id="imageModal" class="modal-overlay">
        <div class="modal">
            <h3 class="modal-title">Seleccionar Imágenes</h3>
            <div class="modal-content">
                <div id="imageSelector" class="image-selector">
                    <!-- Las opciones de imágenes se generarán dinámicamente -->
                </div>
            </div>
            <div class="modal-buttons">
                <button id="cancelImageSelect">Cancelar</button>
                <button id="confirmImageSelect">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        const cameraPreview = document.getElementById('cameraPreview');
        const screenPreview = document.getElementById('screenPreview');
        const pipButton = document.getElementById('pipButton');
        const recordButton = document.getElementById('recordButton');
        const screenButton = document.getElementById('screenButton');
        const cameraButton = document.getElementById('cameraButton');
        const micButton = document.getElementById('micButton');
        const imageButton = document.getElementById('imageButton');
        const status = document.getElementById('status');
        const recordingIndicator = document.querySelector('.recording-indicator');
        const floatImageButton = document.getElementById('floatImageButton');
        const imageModal = document.getElementById('imageModal');
        const imageSelector = document.getElementById('imageSelector');
        const cancelImageSelect = document.getElementById('cancelImageSelect');
        const confirmImageSelect = document.getElementById('confirmImageSelect');

        let mediaRecorder;
        let recordedChunks = [];
        let screenStream = null;
        let cameraStream = null;
        let audioStream = null;
        let combinedStream = null;
        let isRecording = false;
        let uploadedImages = [];
        let floatingImages = new Set();

        class ImageHandler {
            constructor(file, id) {
                this.file = file;
                this.id = id;
                this.url = URL.createObjectURL(file);
                this.name = file.name;
                this.canvas = null;
                this.stream = null;
                this.floatingElement = null;
            }

            async setup() {
                const img = new Image();
                await new Promise(resolve => {
                    img.onload = resolve;
                    img.src = this.url;
                });

                // Crear preview
                const previewBox = document.createElement('div');
                previewBox.className = 'preview-box';
                previewBox.innerHTML = `
                    <div class="preview-title">Vista previa de imagen: ${this.name}</div>
                    <canvas class="preview"></canvas>
                `;
                
                const canvas = previewBox.querySelector('canvas');
                this.setupCanvas(canvas, img);
                document.querySelector('.preview-container').appendChild(previewBox);

                // Almacenar referencia al canvas
                this.canvas = canvas;
                this.stream = canvas.captureStream(30);
            }

            setupCanvas(canvas, img) {
                canvas.width = canvas.offsetWidth;
                canvas.height = (canvas.offsetWidth * 9) / 16;
                
                const ctx = canvas.getContext('2d');
                const drawImage = () => {
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    const scale = Math.min(
                        canvas.width / img.width,
                        canvas.height / img.height
                    );
                    const x = (canvas.width - img.width * scale) / 2;
                    const y = (canvas.height - img.height * scale) / 2;
                    
                    ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                    requestAnimationFrame(drawImage);
                };
                drawImage();
            }

            createFloatingElement() {
    if (this.floatingElement) return;

    const floatingDiv = document.createElement('div');
    floatingDiv.className = 'floating-image';
    floatingDiv.style.width = '320px';
    floatingDiv.style.height = '180px';
    floatingDiv.style.top = '100px';
    floatingDiv.style.left = '100px';

    const canvas = document.createElement('canvas');
    const img = new Image();
    img.onload = () => {
        canvas.width = floatingDiv.offsetWidth;
        canvas.height = floatingDiv.offsetHeight;
        
        const ctx = canvas.getContext('2d');
        const drawImage = () => {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const scale = Math.min(
                canvas.width / img.width,
                canvas.height / img.height
            );
            const x = (canvas.width - img.width * scale) / 2;
            const y = (canvas.height - img.height * scale) / 2;
            
            ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
            requestAnimationFrame(drawImage);
        };
        drawImage();
    };
    img.src = this.url;

    floatingDiv.appendChild(canvas);
    document.body.appendChild(floatingDiv);

    // Hacer la imagen arrastrable
    let isDragging = false;
    let currentX;
    let currentY;

    floatingDiv.addEventListener('mousedown', (e) => {
        if (e.target === floatingDiv) {
            isDragging = true;
            currentX = e.clientX - floatingDiv.offsetLeft;
            currentY = e.clientY - floatingDiv.offsetTop;
        }
    });

    document.addEventListener('mousemove', (e) => {
        if (isDragging) {
            floatingDiv.style.left = `${e.clientX - currentX}px`;
            floatingDiv.style.top = `${e.clientY - currentY}px`;
        }
    });

    document.addEventListener('mouseup', () => {
        isDragging = false;
    });

    // Manejar el redimensionamiento
    const resizeObserver = new ResizeObserver(() => {
        canvas.width = floatingDiv.offsetWidth;
        canvas.height = floatingDiv.offsetHeight;
    });
    resizeObserver.observe(floatingDiv);

    this.floatingElement = floatingDiv;
}

            removeFloatingElement() {
                if (this.floatingElement) {
                    this.floatingElement.remove();
                    this.floatingElement = null;
                }
            }
        }

        // Comprobar soporte de Picture-in-Picture
        if ('pictureInPictureEnabled' in document) {
            cameraPreview.addEventListener('loadedmetadata', () => {
                if (document.pictureInPictureEnabled) {
                    pipButton.disabled = false;
                }
            });
        }

        // Configurar pantalla
        screenButton.addEventListener('click', async () => {
            try {
                screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: true,
                    audio: true
                });
                screenPreview.srcObject = screenStream;
                status.textContent = 'Estado: Pantalla añadida correctamente';
                updateRecordButton();
            } catch (error) {
                console.error('Error al capturar pantalla:', error);
                status.textContent = 'Error: No se pudo capturar la pantalla';
            }
        });

        // Configurar cámara
        cameraButton.addEventListener('click', async () => {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: true
                });
                cameraPreview.srcObject = cameraStream;
                pipButton.disabled = false;
                status.textContent = 'Estado: Cámara añadida correctamente';
                updateRecordButton();
            } catch (error) {
                console.error('Error al configurar cámara:', error);
                status.textContent = 'Error: No se pudo acceder a la cámara';
            }
        });

        // Configurar micrófono
        micButton.addEventListener('click', async () => {
            try {
                audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: true
                });
                status.textContent = 'Estado: Micrófono añadido correctamente';
                updateRecordButton();
            } catch (error) {
                console.error('Error al configurar micrófono:', error);
                status.textContent = 'Error: No se pudo acceder al micrófono';
            }
        });

        // Configurar imágenes
        imageButton.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;
            input.onchange = async (e) => {
                if (e.target.files && e.target.files.length > 0) {
                    for (const file of e.target.files) {
                        const imageHandler = new ImageHandler(file, `img-${Date.now()}-${uploadedImages.length}`);
                        await imageHandler.setup();
                        uploadedImages.push(imageHandler);
                    }
                    floatImageButton.disabled = false;
                    status.textContent = 'Estado: Imágenes añadidas correctamente';
                    updateRecordButton();
                }
            };
            input.click();
        });

        floatImageButton.addEventListener('click', () => {
            if (floatingImages.size > 0) {
                showImageSelectionModal(false);
            } else {
                showImageSelectionModal(true);
            }
        });

        function showImageSelectionModal(isActivating) {
            imageSelector.innerHTML = '';
            uploadedImages.forEach(img => {
                const isFloating = floatingImages.has(img.id);
                if (isActivating !== isFloating) {
                    const option = document.createElement('div');
                    option.className = 'image-option';
                    option.innerHTML = `
                        <input type="checkbox" data-image-id="${img.id}">
                        <span>${img.name}</span>
                    `;
                    imageSelector.appendChild(option);
                }
            });
            imageModal.style.display = 'flex';
        }

        confirmImageSelect.addEventListener('click', () => {
            const selectedCheckboxes = imageSelector.querySelectorAll('input[type="checkbox"]:checked');
            selectedCheckboxes.forEach(checkbox => {
                const imageId = checkbox.dataset.imageId;
                const image = uploadedImages.find(img => img.id === imageId);
                
                if (image) {
                    if (!floatingImages.has(imageId)) {
                        floatingImages.add(imageId);
                        image.createFloatingElement();
                    } else {
                        floatingImages.delete(imageId);
                        image.removeFloatingElement();
                    }
                }
            });
            
            imageModal.style.display = 'none';
            floatImageButton.textContent = floatingImages.size > 0 ? 'Desactivar Imágenes Flotantes' : 'Activar Imagen Flotante';
        });

        cancelImageSelect.addEventListener('click', () => {
            imageModal.style.display = 'none';
        });

        // Activar Picture-in-Picture
        pipButton.addEventListener('click', async () => {
            try {
                if (document.pictureInPictureElement) {
                    await document.exitPictureInPicture();
                } else {
                    await cameraPreview.requestPictureInPicture();
                }
            } catch (error) {
                console.error('Error con Picture-in-Picture:', error);
            }
        });

        function updateRecordButton() {
            const hasVideoSource = screenStream || cameraStream || uploadedImages.length > 0;
            recordButton.disabled = !hasVideoSource;
        }

        // Manejar grabación
        recordButton.addEventListener('click', async () => {
            if (!isRecording) {
                try {
                    const tracks = [];
                    
                    if (screenStream) {
                        tracks.push(...screenStream.getTracks());
                    }
                    
                    if (cameraStream) {
                        tracks.push(...cameraStream.getVideoTracks());
                    }
                    
                    // Añadir tracks de todas las imágenes
                    uploadedImages.forEach(img => {
                        if (img.stream) {
                            tracks.push(...img.stream.getVideoTracks());
                        }
                    });
                    
                    if (audioStream) {
                        tracks.push(...audioStream.getAudioTracks());
                    }

                    combinedStream = new MediaStream(tracks);

                    mediaRecorder = new MediaRecorder(combinedStream, {
                        mimeType: 'video/webm;codecs=vp8,opus'
                    });

                    recordedChunks = [];
                    mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) {
                            recordedChunks.push(e.data);
                        }
                    };

                    mediaRecorder.onstop = () => {
                        const blob = new Blob(recordedChunks, { type: 'video/webm' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `grabacion_${new Date().toISOString().slice(0,19)}.webm`;
                        a.click();
                        URL.revokeObjectURL(url);
                    };

                    mediaRecorder.start();
                    recordButton.textContent = 'Detener Grabación';
                    recordButton.style.backgroundColor = '#ff0000';
                    recordingIndicator.classList.add('active');
                    status.textContent = 'Estado: Grabando...';
                    isRecording = true;

                } catch (error) {
                    console.error('Error al iniciar la grabación:', error);
                    status.textContent = 'Error: No se pudo iniciar la grabación.';
                }
            } else {
                mediaRecorder.stop();
                recordButton.textContent = 'Iniciar Grabación';
                recordButton.style.backgroundColor = '#cc0000';
                recordingIndicator.classList.remove('active');
                status.textContent = 'Estado: Grabación finalizada. Descargando...';
                isRecording = false;
            }
        });

        // Manejar eventos de Picture-in-Picture
        cameraPreview.addEventListener('enterpictureinpicture', () => {
            pipButton.textContent = 'Desactivar Cámara Flotante';
            status.textContent = 'Estado: Cámara flotante activada';
        });

        cameraPreview.addEventListener('leavepictureinpicture', () => {
            pipButton.textContent = 'Activar Cámara Flotante';
            status.textContent = 'Estado: Cámara flotante desactivada';
        });
    </script>
    <script>
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
              .then((registration) => {
                console.log('Service Worker registrado con éxito:', registration);
              })
              .catch((error) => {
                console.log('Error al registrar el Service Worker:', error);
              });
          });
        }
      </script>      
</body>
</html>